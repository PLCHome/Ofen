name: Build Firmware

on:
  push:
    branches:
      - '**'
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Repository auschecken
    - name: Checkout repository
      uses: actions/checkout@v3

    # Installiere Python und PlatformIO
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    # Wenn es ein Tag ist, Version extrahieren
    - name: Check if this is a tag
      id: tag_check
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          echo "is_tag=true" >> $GITHUB_ENV
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        else
          echo "is_tag=false" >> $GITHUB_ENV
        fi

    # Update Version.h nur bei Tags
    - name: Update Version.h
      if: env.is_tag == 'true'
      run: |
        sed -i 's/#define VERSION ".*"/#define VERSION "'$version'"/' src/Version.h

    # Projekt mit PlatformIO bauen
    - name: Build Firmware
      run: pio run

    # Erstelle das Tar-Archiv
    - name: Create spiffs.tar
      run: |
        mkdir -p lastVersion
        tar --transform='s/^data\///' --exclude='data/config' -cf lastVersion/spiffs.tar -C data www sys

    # Verschiebe die erzeugten Dateien in lastVersion
    - name: Move build artifacts
      run: |
        cp .pio/build/*/firmware.bin lastVersion/
        cp .pio/build/*/firmware.elf lastVersion/

    # Commit und push der Artefakte ins Repository
    - name: Commit and push build artifacts
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout ${{ github.ref_name }}
        mkdir -p artifacts
        cp lastVersion/firmware.bin artifacts/
        cp lastVersion/firmware.elf artifacts/
        cp lastVersion/spiffs.tar artifacts/
        git add artifacts/
        git commit -m "Add build artifacts [skip ci]"
        git push origin HEAD

    # Release erstellen nur bei Tags
    - name: Create GitHub Release
      if: env.is_tag == 'true'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        artifacts: |
          lastVersion/firmware.bin
          lastVersion/firmware.elf
          lastVersion/spiffs.tar
        token: ${{ secrets.GITHUB_TOKEN }}
